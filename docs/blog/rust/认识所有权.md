---
title: 认识所有权
order: 4
---

> 关于 Rust 是如何管理运行时内存的一章。

## 什么是所有权

一般来说，所有的程序都需要管理自己在运行时使用的计算机内存空间。某些使用垃圾回收机制的语言会在运行时定期检查并回收那些没有被继续使用的内存；而在另外一些语言中，程序员需要手动分配和释放内存。Rust 采用了与众不同的第三种方式：它使用包含特定规则的所有权系统来管理内存，这套规则允许编译器在编译过程中执行检查工作，而不会产生任何的运行时开销。

## 所有权规则

- Rust 中的每一个值都有一个对应的变量作为它的所有者.
- 在同一时间内，值有且仅有一个所有者。
- 当所有者离开自己的作用域时，它持有的值就会被释放掉。

## String

```rs
let mut s = String::from("hello");

s.push_str(", world!");

println!("{}", s);
```

- 调用 `from` 函数根据字符串字面量来创建一个 `String` 实例
- 双冒号（`::`）运算符允许我们调用至于 `String` 命名空间下面的特定 `from` 函数（关联函数）
- `push_str` 函数向 `String` 空间的尾部添加了一段字面量

> 字符串字面量是不可变的，因为存储在栈中的数据都必须拥有一个已知且固定的大小。
> `String` 是可变的，因为它是存储在堆上的。堆空间的管理是比较松散的：当你希望将数据放入堆中时，你就可以请求特定大小的空间。操作系统会根据你的请求在堆中找到一块足够大的可用空间，将它标记为已使用，并把指向这片空间地址的指针返回给我们。堆的大小原理上是不固定的。

## 内存分配

对应 String 类型而言，为了支持一个可变的、可增长的文本类型，我们需要在堆上分配一块在编译时未知大小的内存来存放数据。这同时也意味着：

- 我们使用的内存是由操作系统在运行时动态分配出来的。
- 当使用完 String 时，我们需要通过某种方式将这些内存归还给操作系统。
